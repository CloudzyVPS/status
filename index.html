<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Cloudzy Status - Service Status Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="align-ui.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="logo">Cloudzy</span>
            <div class="logo-divider"></div>
            <span class="logo-status">Status</span>
        </div>
        <div class="header-center loading" id="header-status">
            <div class="global-status-chip operational">
                <span class="status-dot"></span>
                All Systems Operational
            </div>
        </div>
        <div class="header-right">
            <a href="#" class="header-link">Subscribe</a>
            <a href="#" class="header-link">API</a>
            <a href="#" class="header-link">Support</a>
            <a href="#" class="header-link">History</a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <svg class="sun-icon" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
                <svg class="moon-icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
            </button>
        </div>
    </header>

    <!-- Globe Section -->
    <section class="globe-section loading" id="globe-section">
        <div class="globe-loading-label">Loading‚Ä¶</div>
        <div id="globe-container"></div>
        <div id="labels-container"></div>
        
        <div class="globe-hero-content">
            <h1>Cloudzy Global Infrastructure Status</h1>
        </div>

        <div class="scroll-indicator">
            <span>Scroll to explore</span>
            <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </div>
    </section>

    <div id="region-tooltip">
        <div class="region-name">Region Name</div>
        <div class="delay-list"></div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Summary -->
        <section class="hero-summary section-loadable loading" id="hero-section">
            <div class="container">
                <h2>Service Status</h2>
                <p>All Cloudzy services are operating normally across all regions</p>
                <div class="status-badge-large operational">
                    <svg class="check-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                    All Systems Operational
                </div>
                <div class="last-updated">Last updated: <span id="last-update-time"></span> ‚Ä¢ All times in UTC</div>
            </div>
        </section>

        <!-- Region Status Section -->
        <section class="section section-loadable loading" id="regions-section">
            <div class="container">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Region Status</h2>
                        <p class="section-subtitle">Current status of all Cloudzy data center regions</p>
                    </div>
                </div>
                <div class="region-grid" id="region-grid">
                    <!-- Region cards will be generated by JS -->
                </div>
            </div>
        </section>

        <!-- Network Health & Latency -->
        <section class="section section-loadable loading" id="latency-section">
            <div class="container">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Network Health & Inter-Region Latency</h2>
                        <p class="section-subtitle">Real-time network performance from Dallas (US-Central) hub</p>
                    </div>
                </div>
                <div class="latency-section">
                    <div class="latency-info">
                        <h3>Network Performance</h3>
                        <p>Monitor latency between our global data centers. All measurements are updated in real-time.</p>
                        <div class="latency-legend">
                            <div class="legend-item"><div class="legend-dot low"></div> Normal (&lt;80ms)</div>
                            <div class="legend-item"><div class="legend-dot medium"></div> Elevated (80-150ms)</div>
                            <div class="legend-item"><div class="legend-dot high"></div> High (&gt;150ms)</div>
                        </div>
                    </div>
                    <table class="latency-table" id="latency-table">
                        <thead>
                            <tr>
                                <th>Destination</th>
                                <th>Avg Latency</th>
                                <th>95th Percentile</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Notifications -->
        <section class="section" style="border-bottom: none;">
            <div class="container">
                <div class="notify-section">
                    <h3>Stay Informed</h3>
                    <p>Subscribe to receive notifications about outages and scheduled maintenance</p>
                    <div class="notify-buttons">
                        <a href="#" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                            Subscribe via Email
                        </a>
                        <a href="#" class="btn btn-secondary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg>
                            RSS Feed
                        </a>
                        <a href="#" class="btn btn-secondary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                            API &amp; Webhooks
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#">Cloudzy Home</a>
                    <a href="#">Documentation</a>
                    <a href="#">Security</a>
                    <a href="#">Privacy</a>
                    <a href="#">Terms</a>
                </div>
                <div class="footer-meta">
                    Target uptime: 99.99% for core services
                    ‚Ä¢
                    Status powered by Cloudzy Monitoring as a Service
                </div>
            </div>
        </div>
    </footer>

    <!-- Region Detail Panel -->
    <div class="region-panel-overlay" id="region-panel-overlay" onclick="closeRegionPanel()"></div>
    <div class="region-panel" id="region-panel">
        <div class="panel-header">
            <div class="panel-header-top">
                <div class="panel-title">
                    <h2 id="panel-region-name">Region Name</h2>
                    <span class="region-code" id="panel-region-code">CODE</span>
                </div>
                <button class="panel-close" onclick="closeRegionPanel()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                </button>
            </div>
            <div id="panel-status-badge"></div>
        </div>
        <div class="panel-tabs">
            <button class="panel-tab active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
            <button class="panel-tab" data-tab="incidents" onclick="switchTab('incidents')">Incidents</button>
            <button class="panel-tab" data-tab="maintenance" onclick="switchTab('maintenance')">Maintenance</button>
            <button class="panel-tab" data-tab="latency" onclick="switchTab('latency')">Latency & Performance</button>
        </div>
        <div class="panel-content" id="panel-content">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <script>
        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (typeof updateGlobeTheme === 'function') updateGlobeTheme();
        }

        // Initialize theme
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        }

        // Shared data variables (used by both globe.js and status page)
        let REGIONS = [];
        let NETWORK_DELAYS = {};

        // ============ STATUS PAGE GENERATION ============
        
        // Update last updated time
        function updateTimestamp() {
            const now = new Date();
            const timeStr = now.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
            document.getElementById('last-update-time').textContent = timeStr;
        }
        updateTimestamp();
        setInterval(updateTimestamp, 60000);

        // Region status data - reconstructed from data/regions.json, data/incidents.json, data/maintenance.json
        let REGION_STATUS_DATA = [];

        // Uptime data - loaded from data/uptime.json
        let UPTIME_DATA = {};

        function getUptimeDays(regionName) {
            return UPTIME_DATA[regionName] || Array(30).fill('operational');
        }

        // SVG icons for status
        const STATUS_ICONS = {
            operational: '<svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>',
            degraded: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
            outage: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
            maintenance: '<svg class="icon" viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>',
            unknown: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>'
        };

        const INCIDENT_ICON = '<svg class="badge-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
        const MAINTENANCE_ICON = '<svg class="badge-icon" viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>';

        // Render region cards
        function renderRegionCards() {
            const grid = document.getElementById('region-grid');
            grid.innerHTML = REGION_STATUS_DATA.map((region, index) => {
                const uptimeDays = getUptimeDays(region.name);
                const statusLabels = {
                    operational: 'Operational',
                    degraded: 'Degraded',
                    outage: 'Major Outage',
                    maintenance: 'Maintenance',
                    unknown: 'Unknown'
                };
                
                const hasIncidents = region.activeIncidents && region.activeIncidents.length > 0;
                const hasMaintenance = region.scheduledMaintenance && region.scheduledMaintenance.length > 0;
                
                // Build incident/maintenance badges
                let badges = '';
                if (hasIncidents) {
                    badges += `<span class="incident-badge incident">${INCIDENT_ICON}${region.activeIncidents.length} Incident${region.activeIncidents.length > 1 ? 's' : ''}</span>`;
                }
                if (hasMaintenance) {
                    badges += `<span class="incident-badge maintenance">${MAINTENANCE_ICON}Maintenance</span>`;
                }
                
                return `
                    <div class="region-card" onclick="openRegionPanel(${index})">
                        <div class="region-card-header">
                            <div class="region-info">
                                <h3>${region.flag} ${region.name} <span class="region-code">${region.code}</span>${badges}</h3>
                            </div>
                            <span class="status-pill ${region.status}">
                                ${STATUS_ICONS[region.status] || '<span class="dot"></span>'}
                                ${statusLabels[region.status]}
                            </span>
                        </div>
                        <div class="region-meta">
                            <span>30-day uptime: ${region.uptime}%</span>
                            <span>${!hasIncidents && !hasMaintenance ? 'No active issues' : ''}</span>
                        </div>
                        <div class="uptime-bar">
                            ${uptimeDays.map(d => `<div class="uptime-day ${d === 'operational' ? '' : d}"></div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ REGION PANEL FUNCTIONS ============
        let currentRegionIndex = null;
        let currentTab = 'overview';

        function openRegionPanel(index) {
            currentRegionIndex = index;
            const region = REGION_STATUS_DATA[index];
            
            document.getElementById('panel-region-name').textContent = `${region.flag} ${region.name}`;
            document.getElementById('panel-region-code').textContent = region.code;
            
            const statusLabels = {
                operational: 'Operational',
                degraded: 'Degraded Performance',
                outage: 'Major Outage',
                maintenance: 'Maintenance',
                unknown: 'Unknown'
            };
            
            document.getElementById('panel-status-badge').innerHTML = `
                <span class="status-pill ${region.status}">
                    ${STATUS_ICONS[region.status] || '<span class="dot"></span>'}
                    ${statusLabels[region.status]}
                </span>
            `;
            
            switchTab('overview');
            
            document.getElementById('region-panel-overlay').classList.add('active');
            document.getElementById('region-panel').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeRegionPanel() {
            document.getElementById('region-panel-overlay').classList.remove('active');
            document.getElementById('region-panel').classList.remove('active');
            document.body.style.overflow = '';
            currentRegionIndex = null;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            renderPanelContent();
        }

        function renderPanelContent() {
            if (currentRegionIndex === null) return;
            const region = REGION_STATUS_DATA[currentRegionIndex];
            const content = document.getElementById('panel-content');
            
            switch (currentTab) {
                case 'overview':
                    content.innerHTML = renderOverviewTab(region);
                    break;
                case 'incidents':
                    content.innerHTML = renderIncidentsTab(region);
                    break;
                case 'maintenance':
                    content.innerHTML = renderMaintenanceTab(region);
                    break;
                case 'latency':
                    content.innerHTML = renderLatencyTab(region);
                    break;
            }
        }

        function renderOverviewTab(region) {
            const hasIssues = region.status !== 'operational';
            const hasIncidents = region.activeIncidents && region.activeIncidents.length > 0;
            
            let alertHtml = '';
            if (hasIssues && hasIncidents) {
                alertHtml = `<div class="panel-alert warning">There are currently issues affecting services in ${region.name} (${region.code}). See incidents tab for details.</div>`;
            } else if (region.status === 'maintenance') {
                alertHtml = `<div class="panel-alert info" style="background: var(--state-information-lighter); color: var(--state-information-dark); border-color: var(--state-information-light);">Scheduled maintenance is in progress. See maintenance tab for details.</div>`;
            } else {
                alertHtml = `<div class="panel-alert info">All services in ${region.name} (${region.code}) are operating normally.</div>`;
            }
            
            let incidentPreview = '';
            if (hasIncidents) {
                const incident = region.activeIncidents[0];
                incidentPreview = `
                    <div class="panel-section">
                        <h4 style="font-size: 14px; font-weight: 600; color: var(--text-strong); margin-bottom: 12px;">Active Incidents</h4>
                        <div class="incident-card">
                            <div class="incident-header">
                                <span class="incident-status-badge ${incident.status}">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg>
                                    ${incident.status.charAt(0).toUpperCase() + incident.status.slice(1)}
                                </span>
                                <span class="severity-badge ${incident.severity}">${incident.severity.charAt(0).toUpperCase() + incident.severity.slice(1)}</span>
                            </div>
                            <div class="incident-title">${incident.title}</div>
                            <div class="incident-description">${incident.description}</div>
                            <div class="incident-meta">
                                Started: ${incident.startedAt} ‚Ä¢ <span class="ongoing">Ongoing</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                ${alertHtml}
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">30-Day Uptime</div>
                        <div class="stat-value ${region.uptime > 99.9 ? 'success' : ''}">${region.uptime}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Last Incident</div>
                        <div class="stat-value" style="font-size: 16px;">${region.lastIncident || 'No incidents'}</div>
                    </div>
                </div>
                ${incidentPreview}
            `;
        }

        function renderIncidentsTab(region) {
            const hasIncidents = region.activeIncidents && region.activeIncidents.length > 0;
            
            if (!hasIncidents) {
                return `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                        <div class="empty-state-text">No incidents reported for this region in the last 30 days.</div>
                    </div>
                `;
            }
            
            return region.activeIncidents.map(incident => `
                <div class="incident-card">
                    <div class="incident-header">
                        <span class="incident-status-badge ${incident.status}">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2z"/></svg>
                            ${incident.status.charAt(0).toUpperCase() + incident.status.slice(1)}
                        </span>
                        <span class="severity-badge ${incident.severity}">${incident.severity.charAt(0).toUpperCase() + incident.severity.slice(1)}</span>
                    </div>
                    <div class="incident-title">${incident.title}</div>
                    <div class="incident-description">${incident.description}</div>
                    <div class="incident-meta">
                        Started: ${incident.startedAt} ‚Ä¢ <span class="ongoing">Ongoing</span>
                    </div>
                    
                    <div class="status-updates">
                        <div class="status-updates-title">Status Updates</div>
                        ${incident.updates.map(update => `
                            <div class="update-item">
                                <div class="update-dot ${update.status}"></div>
                                <div class="update-content">
                                    <div class="update-header">
                                        <span class="update-status">${update.status.charAt(0).toUpperCase() + update.status.slice(1)}</span>
                                        <span class="update-time">${update.time}</span>
                                    </div>
                                    <div class="update-message">${update.message}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderMaintenanceTab(region) {
            const hasMaintenance = region.scheduledMaintenance && region.scheduledMaintenance.length > 0;
            
            if (!hasMaintenance) {
                return `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                        <div class="empty-state-text">No scheduled maintenance for this region.</div>
                    </div>
                `;
            }
            
            return region.scheduledMaintenance.map(maint => `
                <div class="incident-card">
                    <div class="incident-header">
                        <span class="incident-status-badge" style="background: var(--state-information-lighter); color: var(--state-information-base);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
                            ${maint.status === 'in_progress' ? 'In Progress' : 'Scheduled'}
                        </span>
                    </div>
                    <div class="incident-title">${maint.title}</div>
                    <div class="incident-description">${maint.description}</div>
                    <div class="incident-meta" style="flex-direction: column; gap: 4px; align-items: flex-start;">
                        <span>Scheduled: ${maint.scheduledStart} - ${maint.scheduledEnd}</span>
                        <span>Impact: ${maint.impact}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderLatencyTab(region) {
            const delays = NETWORK_DELAYS[region.name];
            if (!delays) {
                return `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <div class="empty-state-text">Latency data unavailable for this region.</div>
                    </div>
                `;
            }
            
            return `
                <div class="panel-section">
                    <h4 style="font-size: 14px; font-weight: 600; color: var(--text-strong); margin-bottom: 16px;">Latency from ${region.name} to other regions</h4>
                    <table class="panel-latency-table">
                        <thead>
                            <tr>
                                <th>Destination</th>
                                <th>Avg Latency</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(delays).map(dest => {
                                const latency = delays[dest];
                                const statusClass = latency < 80 ? 'low' : latency < 150 ? 'medium' : 'high';
                                const statusText = latency < 80 ? 'Normal' : latency < 150 ? 'Elevated' : 'High';
                                const targetRegion = REGIONS.find(r => r.name === dest);
                                return `
                                    <tr>
                                        <td>${targetRegion?.flag || ''} ${dest}</td>
                                        <td><span class="latency-value ${statusClass}">${latency} ms</span></td>
                                        <td><span class="status-pill ${statusClass === 'low' ? 'operational' : statusClass === 'medium' ? 'degraded' : 'outage'}" style="font-size: 11px;">${statusText}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Close panel with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeRegionPanel();
        });

        // Render latency table (from Dallas)
        function renderLatencyTable() {
            const tbody = document.querySelector('#latency-table tbody');
            const dallasDelays = NETWORK_DELAYS['Dallas'];
            
            tbody.innerHTML = Object.keys(dallasDelays).map(dest => {
                const latency = dallasDelays[dest];
                const p95 = Math.round(latency * 1.15);
                let statusClass, statusText;
                
                if (latency < 80) {
                    statusClass = 'low';
                    statusText = 'Normal';
                } else if (latency < 150) {
                    statusClass = 'medium';
                    statusText = 'Elevated';
                } else {
                    statusClass = 'high';
                    statusText = 'High';
                }
                
                const regionData = REGIONS.find(r => r.name === dest);
                const flag = regionData?.flag || '';
                
                return `
                    <tr>
                        <td>${flag} ${dest}</td>
                        <td><span class="latency-value ${statusClass}">${latency} ms</span></td>
                        <td><span class="latency-value ${statusClass}">${p95} ms</span></td>
                        <td><span class="status-pill ${statusClass === 'low' ? 'operational' : statusClass === 'medium' ? 'degraded' : 'outage'}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ============ DATA LOADING ============
        const STATUS_API_BASE = 'https://monitoring.cloudzy.com';
        const STATUS_PAGE_SLUG = 'uptime';

        let GLOBAL_STATUS = {};

        // Logging utility with timestamps and context
        const log = {
            info: (message, data = null) => {
                const timestamp = new Date().toISOString();
                console.log(`[${timestamp}] [INFO] ${message}`, data || '');
            },
            warn: (message, data = null) => {
                const timestamp = new Date().toISOString();
                console.warn(`[${timestamp}] [WARN] ${message}`, data || '');
            },
            error: (message, error = null) => {
                const timestamp = new Date().toISOString();
                console.error(`[${timestamp}] [ERROR] ${message}`, error || '');
            },
            debug: (message, data = null) => {
                const timestamp = new Date().toISOString();
                console.debug(`[${timestamp}] [DEBUG] ${message}`, data || '');
            }
        };

        // Log initial configuration
        log.info('Status Page Initialized', {
            apiBase: STATUS_API_BASE,
            pageSlug: STATUS_PAGE_SLUG,
            userAgent: navigator.userAgent,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            timestamp: new Date().toISOString()
        });

        function updateGlobalStatus() {
            log.debug('Updating global status UI', {
                currentStatus: GLOBAL_STATUS.status,
                message: GLOBAL_STATUS.message,
                lastUpdated: GLOBAL_STATUS.lastUpdated
            });
            const chipEl = document.querySelector('.global-status-chip');
            const heroStatusEl = document.querySelector('.status-badge-large');
            const heroMsgEl = document.querySelector('.hero-summary p');

            const statusLabels = {
                operational: 'All Systems Operational',
                degraded: 'Some Systems Experiencing Issues',
                outage: 'Major Outage Detected',
                maintenance: 'Maintenance In Progress'
            };

            const statusIcons = {
                operational: '<svg class="check-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>',
                degraded: '<svg class="check-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
                outage: '<svg class="check-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
                maintenance: '<svg class="check-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>'
            };

            const label = statusLabels[GLOBAL_STATUS.status] || GLOBAL_STATUS.message || 'Unknown';

            // Update header chip
            chipEl.className = 'global-status-chip ' + GLOBAL_STATUS.status;
            chipEl.innerHTML = '<span class="status-dot"></span>' + label;

            // Update hero badge
            heroStatusEl.className = 'status-badge-large ' + GLOBAL_STATUS.status;
            heroStatusEl.innerHTML = (statusIcons[GLOBAL_STATUS.status] || '') + ' ' + label;

            // Update hero message
            heroMsgEl.textContent = GLOBAL_STATUS.message;

            // Update last updated time from API
            if (GLOBAL_STATUS.lastUpdated) {
                const timeStr = new Date(GLOBAL_STATUS.lastUpdated).toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
                document.getElementById('last-update-time').textContent = timeStr;
                log.debug('Updated last-update timestamp', { time: timeStr });
            }

            log.info('Global status UI updated successfully', {
                appliedStatus: GLOBAL_STATUS.status,
                label: statusLabels[GLOBAL_STATUS.status]
            });
        }

        async function loadData() {
            log.info('Starting initial data load', {
                phase: 'PHASE_1_CRITICAL',
                endpoint: `${STATUS_API_BASE}/api/status/${STATUS_PAGE_SLUG}/regions`
            });

            const loadStartTime = performance.now();

            try {
                const base = `${STATUS_API_BASE}/api/status/${STATUS_PAGE_SLUG}`;

                // Phase 1: critical data for first paint (regions endpoint)
                log.debug('Fetching critical regions data...');
                const phase1Start = performance.now();
                const regionsRes = await fetch(`${base}/regions`);
                
                log.info('Regions API response received', {
                    status: regionsRes.status,
                    statusText: regionsRes.statusText,
                    headers: {
                        contentType: regionsRes.headers.get('content-type'),
                        contentLength: regionsRes.headers.get('content-length')
                    },
                    responseTime: `${(performance.now() - phase1Start).toFixed(2)}ms`
                });

                if (!regionsRes.ok) {
                    throw new Error(`API returned ${regionsRes.status}: ${regionsRes.statusText}`);
                }

                const regionsData = await regionsRes.json();
                
                log.info('Regions data parsed successfully', {
                    globalStatus: regionsData.status,
                    regionCount: regionsData.regions?.length || 0,
                    dataSize: JSON.stringify(regionsData).length + ' bytes',
                    regions: regionsData.regions?.map(r => ({
                        name: r.name,
                        status: r.status,
                        uptime: r.uptime,
                        code: r.regionCode
                    }))
                });

                GLOBAL_STATUS = {
                    status: regionsData.status,
                    message: regionsData.message,
                    lastUpdated: regionsData.lastUpdated
                };
                REGIONS = regionsData.regions.map(r => ({ ...r, color: 0xD5EBFF }));
                REGION_STATUS_DATA = regionsData.regions.map(r => ({
                    ...r,
                    activeIncidents: [],       // filled in phase 2
                    scheduledMaintenance: []
                }));

                log.info('Phase 1 data processing complete', {
                    totalTime: `${(performance.now() - phase1Start).toFixed(2)}ms`,
                    globalStatus: GLOBAL_STATUS.status,
                    regionsLoaded: REGIONS.length
                });

                // Render first paint immediately
                log.debug('Rendering Phase 1 UI components...');
                updateGlobalStatus();
                document.getElementById('header-status').classList.remove('loading');
                document.getElementById('hero-section').classList.remove('loading');

                renderRegionCards();
                document.getElementById('regions-section').classList.remove('loading');
                
                log.info('Phase 1 UI render complete - First paint achieved', {
                    timeToFirstPaint: `${(performance.now() - loadStartTime).toFixed(2)}ms`
                });

                // Phase 2: supplementary data (parallel, non-blocking)
                log.info('Starting Phase 2 data load (parallel fetch)', {
                    phase: 'PHASE_2_SUPPLEMENTARY',
                    endpoints: [
                        `${base}/regions/uptime`,
                        `${base}/regions/latency`,
                        `${base}/regions/incidents`,
                        `${base}/regions/maintenance`
                    ]
                });

                const phase2Start = performance.now();
                const [uptimeRes, latencyRes, incidentsRes, maintenanceRes] = await Promise.all([
                    fetch(`${base}/regions/uptime`).then(r => {
                        log.debug('Uptime API response received', { status: r.status });
                        return r.json();
                    }),
                    fetch(`${base}/regions/latency`).then(r => {
                        log.debug('Latency API response received', { status: r.status });
                        return r.json();
                    }),
                    fetch(`${base}/regions/incidents`).then(r => {
                        log.debug('Incidents API response received', { status: r.status });
                        return r.json();
                    }),
                    fetch(`${base}/regions/maintenance`).then(r => {
                        log.debug('Maintenance API response received', { status: r.status });
                        return r.json();
                    })
                ]);

                log.info('Phase 2 parallel fetch complete', {
                    fetchTime: `${(performance.now() - phase2Start).toFixed(2)}ms`,
                    uptimeRegions: Object.keys(uptimeRes.regions || {}).length,
                    latencyMatrixSize: Object.keys(latencyRes.matrix || {}).length,
                    activeIncidents: incidentsRes?.length || 0,
                    maintenanceItems: maintenanceRes?.length || 0
                });

                UPTIME_DATA = uptimeRes.regions;
                NETWORK_DELAYS = latencyRes.matrix;

                log.debug('Processing Phase 2 data...');

                // Re-attach incidents/maintenance to region data
                REGION_STATUS_DATA = REGION_STATUS_DATA.map(r => {
                    const incidents = incidentsRes.filter(inc => inc.region === r.name);
                    const maintenance = maintenanceRes.filter(m => m.region === r.name);
                    
                    if (incidents.length > 0 || maintenance.length > 0) {
                        log.debug(`Region ${r.name} has active issues`, {
                            incidents: incidents.length,
                            maintenance: maintenance.length
                        });
                    }

                    return {
                        ...r,
                        activeIncidents: incidents,
                        scheduledMaintenance: maintenance
                    };
                });

                log.info('Phase 2 data processing complete', {
                    regionsWithIncidents: REGION_STATUS_DATA.filter(r => r.activeIncidents.length > 0).length,
                    regionsWithMaintenance: REGION_STATUS_DATA.filter(r => r.scheduledMaintenance.length > 0).length
                });

                // Re-render with full data
                log.debug('Re-rendering UI with complete data...');
                renderRegionCards();
                document.getElementById('regions-section').classList.remove('loading');

                renderLatencyTable();
                document.getElementById('latency-section').classList.remove('loading');
                
                log.info('Phase 2 UI render complete', {
                    totalPhase2Time: `${(performance.now() - phase2Start).toFixed(2)}ms`
                });

                // Globe-dependent operations (only if globe.js is loaded)
                function initGlobeWithData() {
                    log.info('Initializing 3D globe with region data');
                    initGlobeRegions();
                    precomputeAllArcs();
                    document.getElementById('globe-section').classList.remove('loading');
                    setTimeout(updateGlobeStatusIndicators, 200);
                    log.info('Globe initialization complete');
                }

                if (typeof initGlobeRegions === 'function') {
                    log.debug('Globe.js already loaded, initializing immediately');
                    initGlobeWithData();
                } else {
                    log.debug('Globe.js not yet loaded, deferring initialization');
                    // globe.js hasn't loaded yet ‚Äî store callback for it to pick up
                    window._pendingGlobeInit = initGlobeWithData;
                }

                const totalLoadTime = performance.now() - loadStartTime;
                log.info('‚úÖ Complete data load finished successfully', {
                    totalTime: `${totalLoadTime.toFixed(2)}ms`,
                    phase1Time: `${(performance.now() - phase1Start).toFixed(2)}ms`,
                    phase2Time: `${(performance.now() - phase2Start).toFixed(2)}ms`,
                    regionsLoaded: REGIONS.length,
                    uptimeDataPoints: Object.values(UPTIME_DATA).reduce((sum, r) => sum + (r?.history?.length || 0), 0),
                    latencyPairs: Object.keys(NETWORK_DELAYS).length
                });

            } catch (error) {
                log.error('‚ùå Failed to load status data', {
                    error: error.message,
                    stack: error.stack,
                    endpoint: `${STATUS_API_BASE}/api/status/${STATUS_PAGE_SLUG}`,
                    timestamp: new Date().toISOString()
                });
                
                // Show user-friendly error
                const heroSection = document.getElementById('hero-section');
                if (heroSection) {
                    heroSection.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2 style="color: #ef4444;">Unable to Load Status Data</h2>
                            <p style="color: #6b7280; margin-top: 10px;">Please check your connection and try again.</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Reload Page
                            </button>
                        </div>
                    `;
                }
            }
        }

        log.info('Initiating initial data load...');
        loadData();

        // Auto-refresh: /regions endpoint every 5 minutes
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

        log.info('Auto-refresh configured', {
            interval: `${REFRESH_INTERVAL / 1000}s (${REFRESH_INTERVAL / 60000} minutes)`,
            endpoint: '/regions',
            nextRefresh: new Date(Date.now() + REFRESH_INTERVAL).toISOString()
        });

        async function refreshRegions() {
            log.info('üîÑ Starting auto-refresh', {
                type: 'SCHEDULED_REFRESH',
                endpoint: `${STATUS_API_BASE}/api/status/${STATUS_PAGE_SLUG}/regions`,
                timestamp: new Date().toISOString()
            });

            const refreshStart = performance.now();

            try {
                const base = `${STATUS_API_BASE}/api/status/${STATUS_PAGE_SLUG}`;
                const res = await fetch(`${base}/regions`);
                
                log.debug('Refresh API response received', {
                    status: res.status,
                    responseTime: `${(performance.now() - refreshStart).toFixed(2)}ms`
                });

                if (!res.ok) {
                    log.warn('Refresh request failed', {
                        status: res.status,
                        statusText: res.statusText
                    });
                    return;
                }

                const data = await res.json();

                // Track changes
                const statusChanged = GLOBAL_STATUS.status !== data.status;
                const changedRegions = [];

                GLOBAL_STATUS = {
                    status: data.status,
                    message: data.message,
                    lastUpdated: data.lastUpdated
                };

                // Update region statuses in-place (preserve existing incidents/maintenance)
                for (const updated of data.regions) {
                    const existing = REGION_STATUS_DATA.find(r => r.name === updated.name);
                    if (existing) {
                        if (existing.status !== updated.status) {
                            changedRegions.push({
                                name: existing.name,
                                oldStatus: existing.status,
                                newStatus: updated.status
                            });
                        }
                        existing.status = updated.status;
                        existing.uptime = updated.uptime;
                        existing.incidentCount = updated.incidentCount;
                        existing.maintenanceCount = updated.maintenanceCount;
                    }
                }

                updateGlobalStatus();
                renderRegionCards();
                updateTimestamp();

                log.info('‚úÖ Auto-refresh completed successfully', {
                    refreshTime: `${(performance.now() - refreshStart).toFixed(2)}ms`,
                    globalStatusChanged: statusChanged,
                    newGlobalStatus: data.status,
                    regionsChanged: changedRegions.length,
                    changes: changedRegions.length > 0 ? changedRegions : 'none',
                    nextRefresh: new Date(Date.now() + REFRESH_INTERVAL).toISOString()
                });

            } catch (e) {
                log.error('‚ùå Region refresh failed', {
                    error: e.message,
                    stack: e.stack,
                    refreshTime: `${(performance.now() - refreshStart).toFixed(2)}ms`,
                    nextRetry: new Date(Date.now() + REFRESH_INTERVAL).toISOString()
                });
            }
        }

        setInterval(refreshRegions, REFRESH_INTERVAL);

        // Conditionally load globe only on desktop (large screens)
        const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
        
        log.info('Device detection', {
            isDesktop: isDesktop,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            devicePixelRatio: window.devicePixelRatio,
            userAgent: navigator.userAgent
        });

        if (isDesktop) {
            log.info('Loading 3D globe scripts for desktop view...');
            const threeScript = document.createElement('script');
            threeScript.src = 'https://unpkg.com/three@0.160.0/build/three.min.js';
            threeScript.onload = function() {
                log.info('Three.js library loaded successfully', {
                    version: '0.160.0',
                    source: 'unpkg CDN'
                });
                const globeScript = document.createElement('script');
                globeScript.src = 'globe.js';
                globeScript.onload = function() {
                    log.info('Globe.js script loaded successfully');
                };
                globeScript.onerror = function() {
                    log.error('Failed to load globe.js script');
                };
                document.body.appendChild(globeScript);
            };
            threeScript.onerror = function() {
                log.error('Failed to load Three.js library from CDN');
            };
            document.head.appendChild(threeScript);
        } else {
            log.info('Mobile/tablet device detected - Globe disabled', {
                reason: 'viewport width < 1024px',
                globeSectionHidden: true
            });
            // Hide globe section on small screens
            document.getElementById('globe-section').style.display = 'none';
            document.getElementById('region-tooltip').style.display = 'none';
        }

        // Log page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                log.info('Page hidden - User switched tab/minimized window');
            } else {
                log.info('Page visible - User returned to tab', {
                    timeSinceLastUpdate: GLOBAL_STATUS.lastUpdated 
                        ? `${((Date.now() - new Date(GLOBAL_STATUS.lastUpdated).getTime()) / 1000).toFixed(0)}s ago`
                        : 'unknown'
                });
            }
        });

        // Log when page is about to unload
        window.addEventListener('beforeunload', () => {
            log.info('Page unloading - User navigating away or closing tab');
        });

        log.info('Status page initialization complete', {
            timestamp: new Date().toISOString(),
            readyState: document.readyState
        });
    </script>
</body>
</html>
