// globe.js - 3D Globe visualization for the status page
// Loaded conditionally on desktop (large screens) only
// Requires: Three.js loaded as global, getCurrentTheme() from main script
// Uses globals: REGIONS, NETWORK_DELAYS, REGION_STATUS_DATA

// ============ GLOBE THEME ============
function updateGlobeTheme() {
    if (typeof scene === 'undefined') return;
    
    const theme = getCurrentTheme();
    const colors = CONFIG[theme];
    
    // Update scene background
    scene.background = new THREE.Color(colors.backgroundColor);
    
    // Update globe material
    if (typeof globe !== 'undefined') {
        globe.material.color.setHex(colors.globeColor);
        globe.material.emissive.setHex(colors.globeEmissive);
        globe.material.opacity = 0.5;
    }
    
    // Update atmosphere
    if (typeof atmosphereMaterial !== 'undefined') {
        atmosphereMaterial.uniforms.glowColor.value = new THREE.Color(colors.atmosphereColor);
        atmosphereMaterial.uniforms.opacity.value = 0.15;
    }
    
    // Update land dots
    if (typeof landDots !== 'undefined' && landDots.children[0]) {
        landDots.children[0].material.color.setHex(colors.landColor);
    }
    
    // Update region markers (only operational ones get theme color)
    if (typeof regionMarkers !== 'undefined' && typeof REGION_STATUS_DATA !== 'undefined' && REGION_STATUS_DATA.length > 0) {
        regionMarkers.forEach(r => {
            const regionData = REGION_STATUS_DATA.find(rd => rd.name === r.name);
            const isOperational = !regionData || regionData.status === 'operational';
            
            // Only update color for operational regions; status regions keep their status color
            if (isOperational) {
                r.marker.material.color.setHex(colors.markerColor);
                r.ring.material.color.setHex(colors.markerColor);
                r.pulse.material.color.setHex(colors.markerColor);
            }
            r.baseDot.material.color.setHex(colors.markerColor);
            r.pole.material.color.setHex(colors.markerColor);
        });
    } else if (typeof regionMarkers !== 'undefined') {
        regionMarkers.forEach(r => {
            r.marker.material.color.setHex(colors.markerColor);
            r.ring.material.color.setHex(colors.markerColor);
            r.pulse.material.color.setHex(colors.markerColor);
            r.baseDot.material.color.setHex(colors.markerColor);
            r.pole.material.color.setHex(colors.markerColor);
        });
    }
}

// ============ CONFIG ============
const CONFIG = {
    // Theme colors - dark globe for both modes for consistency & readability
    light: {
        backgroundColor: 0x0e121b,
        globeColor: 0x0A2540,
        globeEmissive: 0x051525,
        landColor: 0x0095ff,
        atmosphereColor: 0x0095ff,
        markerColor: 0x51b1f6
    },
    dark: {
        backgroundColor: 0x0e121b,
        globeColor: 0x0A2540,
        globeEmissive: 0x051525,
        landColor: 0x4488CC,
        atmosphereColor: 0x3399FF,
        markerColor: 0x8fd0ff
    },
    
    globeRadius: 20,
    globeSegments: 72,
    atmosphereOpacity: 0.25,
    
    // Land points
    numPoints: 100000,
    dotSize: 0.04,
    dotOpacity: 0.5,
    
    // Markers - smaller, high-tech
    markerSize: 0.12,
    flagpoleHeight: 0.18,
    ringInner: 0.18,
    ringOuter: 0.28,
    
    // Arcs
    arcThickness: 0.025,
    arcPointsCount: 50,
    
    // Animation
    rotationSpeed: 0.0005,
    
    // Zoom - fixed, no mouse wheel
    fixedZoom: 30,
    
    // Scroll behavior
    defaultZoom: 26,
    scrolledZoom: 38
};

// ============ SCENE SETUP ============
const globeContainer = document.getElementById('globe-container');
const globeSection = document.getElementById('globe-section');
const scene = new THREE.Scene();
const initialTheme = getCurrentTheme();
scene.background = new THREE.Color(CONFIG[initialTheme].backgroundColor);

const camera = new THREE.PerspectiveCamera(75, globeContainer.clientWidth / globeContainer.clientHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance", alpha: true });
renderer.setSize(globeContainer.clientWidth, globeContainer.clientHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
globeContainer.appendChild(renderer.domElement);

// Scroll handling for globe scaling
let scrollProgress = 0;
const labelsContainerEl = document.getElementById('labels-container');

window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const sectionHeight = globeSection.offsetHeight;
    scrollProgress = Math.min(1, scrollTop / (sectionHeight * 0.5));
    
    // Scale globe section height and camera zoom based on scroll
    const newHeight = Math.max(50, 100 - scrollProgress * 40);
    globeSection.style.height = newHeight + 'vh';
    
    // Zoom out as user scrolls
    targetZoom = CONFIG.defaultZoom + (scrollProgress * 12);
    
    // Hide labels when scrolled past globe
    labelsContainerEl.style.opacity = Math.max(0, 1 - scrollProgress * 2);
});

const globeGroup = new THREE.Group();
// Move the globe group directly
globeGroup.position.set(0, -10, 0);  // Shift globe down by 2 units
scene.add(globeGroup);

const radius = CONFIG.globeRadius;

// Modern blue globe with sharp colors - theme aware
const themeColors = CONFIG[initialTheme];
const globeGeometry = new THREE.SphereGeometry(radius, CONFIG.globeSegments, CONFIG.globeSegments);
const globeMaterial = new THREE.MeshPhongMaterial({
    color: themeColors.globeColor,
    shininess: 30,
    specular: 0x1A4A80,
    emissive: themeColors.globeEmissive,
    transparent: true,
    opacity: initialTheme === 'light' ? 0.7 : 0.5
});
const globe = new THREE.Mesh(globeGeometry, globeMaterial);
globeGroup.add(globe);

// Inner glow
const innerGlow = new THREE.Mesh(
    new THREE.SphereGeometry(radius * 1.008, 48, 48),
    new THREE.MeshBasicMaterial({
        color: 0x0066CC,
        transparent: true,
        opacity: 0.05,
        side: THREE.BackSide
    })
);
globeGroup.add(innerGlow);

// Atmosphere - theme aware
const atmosphereMaterial = new THREE.ShaderMaterial({
    uniforms: {
        glowColor: { value: new THREE.Color(themeColors.atmosphereColor) },
        opacity: { value: initialTheme === 'light' ? 0.15 : CONFIG.atmosphereOpacity },
        time: { value: 0.0 }
    },
    vertexShader: `
        varying vec3 vNormal;
        void main() {
            vNormal = normalize(normalMatrix * normal);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    `,
    fragmentShader: `
        uniform vec3 glowColor;
        uniform float opacity;
        uniform float time;
        varying vec3 vNormal;
        void main() {
            float intensity = pow(0.7 - dot(vNormal, vec3(0, 0, 1.0)), 2.5);
            float pulse = 1.0 + 0.08 * sin(time * 0.4);
            gl_FragColor = vec4(glowColor * pulse, opacity * intensity * 2.0);
        }
    `,
    side: THREE.BackSide,
    transparent: true,
    blending: THREE.AdditiveBlending,
    depthWrite: false
});
const atmosphere = new THREE.Mesh(new THREE.SphereGeometry(radius * 1.12, 64, 64), atmosphereMaterial);
globeGroup.add(atmosphere);

// Lights - modern blue tones
scene.add(new THREE.AmbientLight(0x1a2a4a, 0.6));

const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
mainLight.position.set(10, 10, 10);
scene.add(mainLight);

const blueLight = new THREE.PointLight(0x0088FF, 3, 80);
blueLight.position.set(-25, 10, -25);
scene.add(blueLight);

const accentLight = new THREE.PointLight(0x00AAFF, 2, 60);
accentLight.position.set(15, -10, 20);
scene.add(accentLight);

// Camera position
let targetZoom = CONFIG.defaultZoom;
camera.position.z = targetZoom;
camera.position.y = 2;
camera.lookAt(0, 0, 0);

// ============ LAND DOTS ============
const landDots = new THREE.Group();
globeGroup.add(landDots);

const worldMap = ["000000000000000000000000000000000000000000000000000000001111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000000111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000001111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000001111111110111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000000111111000011111111111111111111110000000000000000000000000000000000000000000000000011111111100000000000000000000000000000000000000000000000000","000000000000000000000000000000001110000000000000000000000000000011111111111111111110000000000000000000000000000000000000000000000000111111111111100000000000000000000000000000000000000000000000000","000000000000000000000000000000111111101110000000111111100000000011111111111111110000000000000000000000000000000000000000000011100111111111111111111100111100000011000000000000000000000000000000000","000000000000001111100000000000111111111110011100111111111000000001111111111111110000000000000000000000000000000000000000000011111111111111111111111111111111110011111111110000000000000000000000000","000000001111111111110000111110000111111110011100110111111000000001111111111111110000000000000000000001111111110000000000110011111111111111111111111111111111111111111111111111110011100000000000000","000001111111111111111111111111111111111100111111110001111100001111111111111111100000000000000000000111111111111110001111111101111111111111111111111111111111111111111111111111111111111111000000000","000111111111111111111111111111111111111111111111100001111100000111111111100000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000","001111111111111111111111111111111111111111111110000111111100000111111111000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000","001111111111111111111111111111111111111111111000000111111000000111111000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111000","111111111111111111111111111111111111111111110000010011110000000111111000000000000000000000000001111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000","111111111111111111111111111111111111111110000000111100110000000011110000000000000000000000000011111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000","111111111111111111111111111111111111111000000011111100110000000001100000000000000000000000000011111111011111111111111111111111111111111111111111111111111111111111111111111111111100011111100000000","111110100000111111111111111111111111110000000011111111110000000000000000000000000000000000000011111111001111111111111111111111111111111111111111111111111111111111111111111111111100111101000000000","011000000000011111111111111111111111111000000011111111110000000000000000000000000000000000000000011110111111111111111111111111111111111111111111111111111111111111111111111000000000111110000000000","000000000000001111111111111111111111111111100011111111110000000000000000000000000000000000000000011110111111111111111111111111111111111111111111111111111111111111111111111000000000111111000000000","000000000000011111111111111111111111111111111111111111111100000000000000000000000000000000000001111011111111111111111111111111111111111111111111111111111111111111111111111000000000011111000000000","000000000000011111111111111111111111111111011111111111111100000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111100000001111000000000","000000000000011111111111111111111111111111111111111111111100000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000111000000000","000000000000011111111111111111111111111111111111111111111000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000011000000000","000000000000001111111111111111111111111111111111111111000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000","000000000000011111111111111111111111111111111111111100000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000","000000000000011111111111111111111111111111111111111111000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000","000000000000111111111111111111111111111111111111111111000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000100000000000000","000000000001111111111111111111111111111111111111111100000000000000000000000000000000011001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000110000000000000","000000000001111111111111111111111111111111111110110000000000000000000000000000000000111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111110000111000000000000","000000000011111111111111111111111111111111111100000000000000000000000000000000000000111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111000000111000000000000","000000000111111111111111111111111111111111111000000000000000000000000000000000000000111111110000000111111111111111111111111111111111111111111111111111111111111111111111111111000000110000000000000","000000000111111111111111111111111111111111100000000000000000000000000000000000000000111111100000000111111101111111111111111111111111111111111111111111111111111111111111011111000000110000000000000","000000000111111111111111111111111111111111000000000000000000000000000000000000000000111111100000001110011101111111111111111111111111111111111111111111111111111111111110000111100010110000000000000","000000000111111111111111111111111111111110000000000000000000000000000000000000000000111110011111111100011101111111111111111111111111111111111111111111111111111111111111110111110111111000000000000","000000000111111111111111111111111111111110000000000000000000000000000000000000000000001111111111110000000000011011111111111111111111111111111111111111111111111111111111110011110111111000000000000","000000000011111111111111111111111111111000000000000000000000000000000000000000000000011111111111100000000000000001111111111111111111111111111111111111111111111111111111110011100111110000000000000","000000000001111111111111111111111111110000000000000000000000000000000000000000000001111111111111111000011000000001111111111111111111111111111111111111111111111111111111110000000000000000000000000","000000000000111111111111111111111111100000000000000000000000000000000000000000000001111111111111111110011111110011111111111111111111111111111111111111111111111111111111111100000000000000000000000","000000000001111111111111111111111111000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000","000000000000111111111111111111100111000000000000000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000","000000000000111111111111110000000111000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000","000000000000111111111111000000000111000000000000000000000000000000000000000000001111111111111111111111111111111110111111111101111111111111111111111111111111111111111111111100000000000000000000000","000000000000011111111111000000000011000000000000000000000000000000000000000000011111111111111111111111111111111111111111111100011111111111111111111111111111111111111111111100000000000000000000000","000000000000011011111111000000000000000000000000000000000000000000000000000000011111111111111111111111111111111111011111111111111000001111111111111111111111111111111111111000000000000000000000000","000000000000000011111111000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111110000011111111111111111111111111111111110000000000000000000000000","000000000000000011111110000111000000000000000000000000000000000000000000000000111111111111111111111111111111111111101111111111111110000001111111111111111111111111111111000000000000000000000000000","000000000000000001111111000111000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111110000000111111111111000111111111100110000000000000000000000000000","000000000000000001111111101111000000000000000000000000000000000000000000000000111111111111111111111111111111111111110111111111111100000000001111111110000111111111101110000000000000000000000000000","000000000000000001111111111111000000000000000000000000000000000000000000000000111111111111111111111111111111111111111011111111111000000000001111111100000011111111111100000000000000000000000000000","000000000000000000011111111111100000000000000000000000000000000000000000000000111111111111111111111111111111111111111011111111110000000000001111111000000001111111111000000000000000000000000000000","000000000000000000000111111111110000000000000000000000000000000000000000000001111111111111111111111111111111111111111101111111100000000000001111110000000001111111111000000000000000000000000000000","000000000000000000000000011111110000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111110000000000000000111110000000000011111111100000000000000000000000000000","000000000000000000000000000111110000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111000000000000000000111110000000000011111111100000000000000000000000000000","000000000000000000000000000001110000001111000000000000000000000000000000000001111111111111111111111111111111111111111111000011000000000000000111110000000000011111111100000000000000000000000000000","000000000000000000000000000001110000111111111100000000000000000000000000000000011111111111111111111111111111111111111111111111000000000000000011110000000000011111111100000000000000000000000000000","000000000000000000000000000001111001111111111110000000000000000000000000000000011111111111111111111111111111111111111111111111000000000000000011110000000000011101111000000000000000000000000000000","000000000000000000000000000000011101111111111111100000000000000000000000000000001111111111111111111111111111111111111111111110000000000000000001100000000000001100100000000000000000000000000000000","000000000000000000000000000000000101111111111111110000000000000000000000000000000111111111111111111111111111111111111111111110000000000000000000000000000000000000000000001100000000000000000000000","000000000000000000000000000000000001111111111111111110000000000000000000000000000111111111111111111111111111111111111111111100000000000000000000000000000000110000000000001110000000000000000000000","000000000000000000000000000000000001111111111111111111000000000000000000000000000001111100000111111111111111111111111111111000000000000000000000000000000000111000000000111110000000000000000000000","000000000000000000000000000000000011111111111111111111100000000000000000000000000000000000000000111111111111111111111111111000000000000000000000000000000000011100000001111110000000000000000000000","000000000000000000000000000000000011111111111111111111100000000000000000000000000000000000000000111111111111111111111111110000000000000000000000000000000000011110000011111110000000000000000000000","000000000000000000000000000000000111111111111111111111100000000000000000000000000000000000000000111111111111111111111111100000000000000000000000000000000000001111000111111110000000000000000000000","000000000000000000000000000000001111111111111111111111111000000000000000000000000000000000000001111111111111111111111111000000000000000000000000000000000000000111100111111100000000011100000000000","000000000000000000000000000000001111111111111111111111111111000000000000000000000000000000000001111111111111111111111111000000000000000000000000000000000000000111100011111100000000011101100000000","000000000000000000000000000000000111111111111111111111111111111000000000000000000000000000000000111111111111111111111110000000000000000000000000000000000000000011110011111000000000001111111100000","000000000000000000000000000000001111111111111111111111111111111110000000000000000000000000000000011111111111111111111100000000000000000000000000000000000000000011110000000000000000001111111111000","000000000000000000000000000000001111111111111111111111111111111111000000000000000000000000000000011111111111111111111000000000000000000000000000000000000000000001110000000000000000000001111111100","000000000000000000000000000000000111111111111111111111111111111111000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000110000000000000000000000111111100","000000000000000000000000000000000011111111111111111111111111111111000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000000000000000000000111111110","000000000000000000000000000000000011111111111111111111111111111110000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000000000000000000000011101111","000000000000000000000000000000000001111111111111111111111111111100000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000111","000000000000000000000000000000000001111111111111111111111111111100000000000000000000000000000000000111111111111111111100000000000000000000000000000000000000000000000000000000000000011110001100001","000000000000000000000000000000000001111111111111111111111111111100000000000000000000000000000000001111111111111111111100000110000000000000000000000000000000000000000000000000000000111110001100000","000000000000000000000000000000000000111111111111111111111111111000000000000000000000000000000000001111111111111111111100001110000000000000000000000000000000000000000000000000001111111100011100000","000000000000000000000000000000000000011111111111111111111111111000000000000000000000000000000000011111111111111111111100111110000000000000000000000000000000000000000000000000011111111110011110000","000000000000000000000000000000000000001111111111111111111111111000000000000000000000000000000000011111111111111111111000111110000000000000000000000000000000000000000000000000111111111111111110000","000000000000000000000000000000000000000011111111111111111111111000000000000000000000000000000000011111111111111111110000111110000000000000000000000000000000000000000000000001111111111111111110000","000000000000000000000000000000000000000001111111111111111111111000000000000000000000000000000000001111111111111111100000111100000000000000000000000000000000000000000000000011111111111111111111000","000000000000000000000000000000000000000001111111111111111111110000000000000000000000000000000000001111111111111111100001111100000000000000000000000000000000000000000000011111111111111111111111000","000000000000000000000000000000000000000001111111111111111111110000000000000000000000000000000000000111111111111111100001111000000000000000000000000000000000000000000001111111111111111111111111100","000000000000000000000000000000000000000001111111111111111111110000000000000000000000000000000000000111111111111111100001111000000000000000000000000000000000000000000001111111111111111111111111110","000000000000000000000000000000000000000001111111111111111110000000000000000000000000000000000000000111111111111111100001111000000000000000000000000000000000000000000001111111111111111111111111110","000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000111111111111111000001111000000000000000000000000000000000000000000001111111111111111111111111110","000000000000000000000000000000000000000001111111111111111100000000000000000000000000000000000000000011111111111110000000000000000000000000000000000000000000000000000001111111111111111111111111110","000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000011111111111100000000000000000000000000000000000000000000000000000011111111111111111111111111110","000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000011111111111100000000000000000000000000000000000000000000000000000011111111111111111111111111110","000000000000000000000000000000000000000001111111111111110000000000000000000000000000000000000000000001111111111000000000000000000000000000000000000000000000000000000001111111111111111111111111110","000000000000000000000000000000000000000001111111111111110000000000000000000000000000000000000000000001111111110000000000000000000000000000000000000000000000000000000001111111111111111111111111100","000000000000000000000000000000000000000000111111111111100000000000000000000000000000000000000000000000111111100000000000000000000000000000000000000000000000000000000011111111100011111111111111000","000000000000000000000000000000000000000000111111111111100000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000011111100000001111111111110000","000000000000000000000000000000000000000000111111111110000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000011000000000000011111111100000","000000000000000000000000000000000000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000","000000000000000000000000000000000000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111110000000","000000000000000000000000000000000000000000111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000000000","000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000011111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000011111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000011111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"];

function isLand(lat, lon) {
    const latIdx = Math.min(worldMap.length - 1, Math.max(0, Math.floor((90 - lat) * worldMap.length / 180)));
    const lonIdx = Math.min(worldMap[0].length - 1, Math.max(0, Math.floor((lon + 180) * worldMap[0].length / 360)));
    return worldMap[latIdx]?.[lonIdx] === '1';
}

function createLandPoints() {
    const geo = new THREE.CircleGeometry(CONFIG.dotSize, 6);
    const mat = new THREE.MeshBasicMaterial({ color: themeColors.landColor, side: THREE.DoubleSide, transparent: true, opacity: CONFIG.dotOpacity });
    const positions = [], normals = [];

    for (let i = 0; i < CONFIG.numPoints; i++) {
        const phi = Math.acos(1 - 2 * (i + 0.5) / CONFIG.numPoints);
        const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
        const lat = 90 - (phi * 180 / Math.PI);
        const lon = (theta * 180 / Math.PI) % 360 - 180;
        if (isLand(lat, lon)) {
            const p = (90 - lat) * Math.PI / 180, t = (lon + 180) * Math.PI / 180;
            const r = radius * 1.003;
            const x = -r * Math.sin(p) * Math.cos(t), y = r * Math.cos(p), z = r * Math.sin(p) * Math.sin(t);
            positions.push(x, y, z);
            const n = new THREE.Vector3(x, y, z).normalize();
            normals.push(n.x, n.y, n.z);
        }
    }

    const count = positions.length / 3;
    if (count > 0) {
        const mesh = new THREE.InstancedMesh(geo, mat, count);
        const m = new THREE.Matrix4(), q = new THREE.Quaternion(), pos = new THREE.Vector3(), s = new THREE.Vector3(1, 1, 1);
        for (let i = 0; i < count; i++) {
            pos.set(positions[i * 3], positions[i * 3 + 1], positions[i * 3 + 2]);
            const n = new THREE.Vector3(normals[i * 3], normals[i * 3 + 1], normals[i * 3 + 2]);
            const rm = new THREE.Matrix4().lookAt(pos, pos.clone().add(n), new THREE.Vector3(0, 1, 0));
            q.setFromRotationMatrix(rm);
            m.compose(pos, q, s);
            mesh.setMatrixAt(i, m);
        }
        mesh.instanceMatrix.needsUpdate = true;
        landDots.add(mesh);
    }
}
createLandPoints();

// ============ REGION MARKERS WITH FLAGS ============
const regionMarkers = [];
const regionGroup = new THREE.Group();
globeGroup.add(regionGroup);
const labelsContainer = document.getElementById('labels-container');

function latLonToVector3(lat, lon, r) {
    // Convert lat/lon to radians
    const latRad = lat * Math.PI / 180;
    const lonRad = -lon * Math.PI / 180; // Negative to match geographic convention
    
    // Spherical to Cartesian conversion (Y-up coordinate system)
    const x = r * Math.cos(latRad) * Math.sin(lonRad);
    const y = r * Math.sin(latRad);
    const z = r * Math.cos(latRad) * Math.cos(lonRad);
    
    return new THREE.Vector3(x, y, z);
}

// Get region status from REGION_STATUS_DATA
function getRegionStatus(regionName) {
    // Will be populated after REGION_STATUS_DATA is defined
    return null;
}

function createRegionMarker(region) {
    const markerColor = themeColors.markerColor;
    const basePos = latLonToVector3(region.lat, region.lon, radius * 1.003);
    const normal = basePos.clone().normalize();
    const flagPos = basePos.clone().add(normal.clone().multiplyScalar(CONFIG.flagpoleHeight));

    // Thin high-tech pole line
    const poleGeo = new THREE.BufferGeometry().setFromPoints([basePos, flagPos]);
    const poleMat = new THREE.LineBasicMaterial({ color: markerColor, transparent: true, opacity: 0.4 });
    const pole = new THREE.Line(poleGeo, poleMat);
    regionGroup.add(pole);

    // Small base dot on globe
    const baseDotGeo = new THREE.SphereGeometry(0.05, 8, 8);
    const baseDotMat = new THREE.MeshBasicMaterial({ color: markerColor, transparent: true, opacity: 0.9 });
    const baseDot = new THREE.Mesh(baseDotGeo, baseDotMat);
    baseDot.position.copy(basePos);
    regionGroup.add(baseDot);

    // Small marker dot at top - high-tech feel
    const markerGeo = new THREE.SphereGeometry(CONFIG.markerSize, 12, 12);
    const markerMat = new THREE.MeshBasicMaterial({ color: markerColor, transparent: true, opacity: 0.95 });
    const marker = new THREE.Mesh(markerGeo, markerMat);
    marker.position.copy(flagPos);
    regionGroup.add(marker);

    // Inner tech ring
    const ringGeo = new THREE.RingGeometry(CONFIG.ringInner, CONFIG.ringOuter, 32);
    const ringMat = new THREE.MeshBasicMaterial({ color: markerColor, transparent: true, opacity: 0.25, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.position.copy(flagPos);
    ring.lookAt(camera.position);
    regionGroup.add(ring);

    // Outer pulse ring - smaller
    const pulseGeo = new THREE.RingGeometry(CONFIG.ringOuter + 0.05, CONFIG.ringOuter + 0.12, 32);
    const pulseMat = new THREE.MeshBasicMaterial({ color: markerColor, transparent: true, opacity: 0.1, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });
    const pulse = new THREE.Mesh(pulseGeo, pulseMat);
    pulse.position.copy(flagPos);
    pulse.lookAt(camera.position);
    regionGroup.add(pulse);

    // HTML label with flag - bigger text
    const label = document.createElement('div');
    label.className = 'region-label';
    label.innerHTML = `<span class="flag">${region.flag}</span> ${region.name}`;
    labelsContainer.appendChild(label);

    return {
        name: region.name, position: flagPos.clone(), basePosition: basePos.clone(),
        marker, ring, pulse, pole, baseDot, color: new THREE.Color(markerColor),
        lat: region.lat, lon: region.lon, label, flag: region.flag,
        markerMat, ringMat, pulseMat
    };
}

// ============ PERSISTENT ARCS (lighter on load) ============
const persistentArcs = [];
const arcsGroup = new THREE.Group();
globeGroup.add(arcsGroup);

// Data packet group for transfer animations
const dataPacketsGroup = new THREE.Group();
globeGroup.add(dataPacketsGroup);

function createPersistentArc(startR, endR) {
    const s = startR.position.clone(), e = endR.position.clone();
    const mid = s.clone().add(e).multiplyScalar(0.5);
    mid.normalize().multiplyScalar(radius + s.distanceTo(e) * 0.35);

    const pts = [];
    for (let i = 0; i <= 40; i++) {
        const t = i / 40, u = 1 - t;
        pts.push(new THREE.Vector3(
            u * u * s.x + 2 * u * t * mid.x + t * t * e.x,
            u * u * s.y + 2 * u * t * mid.y + t * t * e.y,
            u * u * s.z + 2 * u * t * mid.z + t * t * e.z
        ));
    }

    // Light blue gradient for persistent arcs
    const canvas = document.createElement('canvas');
    canvas.width = 256; canvas.height = 1;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createLinearGradient(0, 0, 256, 0);
    grad.addColorStop(0, 'rgba(60, 160, 255, 0.6)');
    grad.addColorStop(0.5, 'rgba(100, 200, 255, 0.8)');
    grad.addColorStop(1, 'rgba(60, 160, 255, 0.6)');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 256, 1);
    const tex = new THREE.CanvasTexture(canvas);

    const curve = new THREE.CatmullRomCurve3(pts);
    curve.tension = 0.5;
    const geo = new THREE.TubeGeometry(curve, 16, 0.018, 6, false);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, opacity: 0.45, depthWrite: false, blending: THREE.AdditiveBlending });
    const arc = new THREE.Mesh(geo, mat);
    arcsGroup.add(arc);
    return { arc, mat, curve, pts };
}

// ============ DATA PACKET ANIMATION ============
const dataPackets = [];

// Create a glowing data packet
function createDataPacket(arcData, direction = 1, delay = 0) {
    // Core bright sphere
    const coreGeo = new THREE.SphereGeometry(0.06, 8, 8);
    const coreMat = new THREE.MeshBasicMaterial({
        color: 0x00ffff,
        transparent: true,
        opacity: 1,
        blending: THREE.AdditiveBlending
    });
    const core = new THREE.Mesh(coreGeo, coreMat);
    
    // Outer glow sphere
    const glowGeo = new THREE.SphereGeometry(0.12, 8, 8);
    const glowMat = new THREE.MeshBasicMaterial({
        color: 0x3399ff,
        transparent: true,
        opacity: 0.4,
        blending: THREE.AdditiveBlending
    });
    const glow = new THREE.Mesh(glowGeo, glowMat);
    
    // Trail particles
    const trailGroup = new THREE.Group();
    const trailCount = 5;
    for (let i = 0; i < trailCount; i++) {
        const trailGeo = new THREE.SphereGeometry(0.03 - i * 0.004, 6, 6);
        const trailMat = new THREE.MeshBasicMaterial({
            color: 0x66ccff,
            transparent: true,
            opacity: 0.3 - i * 0.05,
            blending: THREE.AdditiveBlending
        });
        const trail = new THREE.Mesh(trailGeo, trailMat);
        trail.userData.offset = (i + 1) * 0.02;
        trailGroup.add(trail);
    }
    
    const packetGroup = new THREE.Group();
    packetGroup.add(core);
    packetGroup.add(glow);
    packetGroup.add(trailGroup);
    dataPacketsGroup.add(packetGroup);
    
    return {
        group: packetGroup,
        core,
        glow,
        trailGroup,
        curve: arcData.curve,
        progress: direction === 1 ? 0 : 1,
        direction,
        speed: 0.08 + Math.random() * 0.06,
        delay,
        delayTimer: delay,
        active: delay === 0
    };
}

// Initialize data packets on arcs
function initDataPackets() {
    persistentArcs.forEach((arcData, index) => {
        // Create 2-3 packets per arc with varied timing
        const numPackets = 2 + Math.floor(Math.random() * 2);
        for (let i = 0; i < numPackets; i++) {
            const direction = Math.random() > 0.5 ? 1 : -1;
            const delay = i * 2.5 + Math.random() * 4;
            dataPackets.push(createDataPacket(arcData, direction, delay));
        }
    });
}

// Update data packets
function updateDataPackets(dt) {
    dataPackets.forEach(packet => {
        if (!packet.active) {
            packet.delayTimer -= dt;
            if (packet.delayTimer <= 0) {
                packet.active = true;
                packet.group.visible = true;
            } else {
                packet.group.visible = false;
                return;
            }
        }
        
        // Move along curve slowly
        packet.progress += packet.direction * packet.speed * dt;
        
        // Reset when reaching end
        if (packet.progress >= 1 || packet.progress <= 0) {
            packet.direction *= -1;
            packet.progress = Math.max(0, Math.min(1, packet.progress));
            
            // Pause before going back
            if (Math.random() > 0.5) {
                packet.active = false;
                packet.delayTimer = 1 + Math.random() * 3;
            }
        }
        
        // Get position on curve
        const t = Math.max(0.001, Math.min(0.999, packet.progress));
        const pos = packet.curve.getPointAt(t);
        packet.core.position.copy(pos);
        packet.glow.position.copy(pos);
        
        // Update trail positions
        packet.trailGroup.children.forEach((trail, i) => {
            const trailProgress = packet.progress - packet.direction * trail.userData.offset;
            if (trailProgress > 0.001 && trailProgress < 0.999) {
                const trailPos = packet.curve.getPointAt(trailProgress);
                trail.position.copy(trailPos);
                trail.visible = true;
            } else {
                trail.visible = false;
            }
        });
        
        // Pulse effect for the glow
        const pulse = 0.85 + Math.sin(Date.now() * 0.008 + packet.progress * 8) * 0.15;
        packet.core.scale.setScalar(pulse);
        packet.glow.scale.setScalar(pulse * 1.1);
    });
}

// initGlobeRegions() is called after data is loaded from JSON
function initGlobeRegions() {
    REGIONS.forEach(r => regionMarkers.push(createRegionMarker(r)));

    // Apply initial theme to globe after all elements are created
    setTimeout(() => updateGlobeTheme(), 100);

    // Create persistent arcs between regions
    const connections = [
        ['New York', 'London'], ['New York', 'Los Angeles'], ['London', 'Frankfurt'],
        ['London', 'Dubai'], ['Frankfurt', 'Singapore'], ['Dubai', 'Singapore'],
        ['Los Angeles', 'Las Vegas'], ['Los Angeles', 'Dallas'], ['Amsterdam', 'London'],
        ['Dallas', 'Miami'], ['Utah', 'Las Vegas'], ['Bern', 'Frankfurt']
    ];
    connections.forEach(([a, b]) => {
        const sa = regionMarkers.find(r => r.name === a), sb = regionMarkers.find(r => r.name === b);
        if (sa && sb) persistentArcs.push(createPersistentArc(sa, sb));
    });

    // Initialize packets after arcs are created
    initDataPackets();
}

// ============ HOVER ARCS (Pre-computed for smooth performance) ============
let hoveredRegion = null;
const hoverArcsGroup = new THREE.Group();
globeGroup.add(hoverArcsGroup);

// Pre-compute all arc data at startup
const precomputedArcs = new Map();

// Get latency color based on delay value
function getLatencyColor(delay) {
    if (delay < 80) return { hex: '#00DDAA', rgb: 'rgba(0, 221, 170, 1)' }; // Green - low
    if (delay < 150) return { hex: '#FFB432', rgb: 'rgba(255, 180, 50, 1)' }; // Yellow - medium
    return { hex: '#FF5566', rgb: 'rgba(255, 85, 102, 1)' }; // Red - high
}

function precomputeArcData(startR, endR) {
    const s = startR.position.clone(), e = endR.position.clone();
    const mid = s.clone().add(e).multiplyScalar(0.5);
    mid.normalize().multiplyScalar(radius + s.distanceTo(e) * 0.45);

    const pts = [];
    for (let i = 0; i <= CONFIG.arcPointsCount; i++) {
        const t = i / CONFIG.arcPointsCount, u = 1 - t;
        pts.push(new THREE.Vector3(
            u * u * s.x + 2 * u * t * mid.x + t * t * e.x,
            u * u * s.y + 2 * u * t * mid.y + t * t * e.y,
            u * u * s.z + 2 * u * t * mid.z + t * t * e.z
        ));
    }

    return { points: pts, startR, endR };
}

// Pre-compute all arcs between all region pairs (called after initGlobeRegions)
function precomputeAllArcs() {
    regionMarkers.forEach(startR => {
        regionMarkers.forEach(endR => {
            if (startR !== endR) {
                const key = `${startR.name}->${endR.name}`;
                precomputedArcs.set(key, precomputeArcData(startR, endR));
            }
        });
    });
}

// Active hover arc objects
let activeHoverArcs = [];

function activateHoverArcs(sourceRegion) {
    if (!NETWORK_DELAYS || !NETWORK_DELAYS[sourceRegion.name]) return;

    regionMarkers.forEach(targetR => {
        if (targetR !== sourceRegion) {
            const key = `${sourceRegion.name}->${targetR.name}`;
            const data = precomputedArcs.get(key);
            if (data) {
                const delay = NETWORK_DELAYS[sourceRegion.name][targetR.name];
                const latencyColor = getLatencyColor(delay);
                
                // Create material with latency-based color
                const mat = new THREE.MeshBasicMaterial({ 
                    color: new THREE.Color(latencyColor.hex),
                    transparent: true, 
                    opacity: 0.9, 
                    depthWrite: false, 
                    blending: THREE.AdditiveBlending 
                });
                
                // Start with minimal tube
                const initialPts = data.points.slice(0, 2);
                const initialCurve = new THREE.CatmullRomCurve3(initialPts);
                const tubeGeo = new THREE.TubeGeometry(initialCurve, 2, CONFIG.arcThickness, 6, false);
                const arc = new THREE.Mesh(tubeGeo, mat);
                arc.visible = true;
                hoverArcsGroup.add(arc);
                
                activeHoverArcs.push({ 
                    arc, 
                    mat, 
                    allPoints: data.points, 
                    progress: 0, 
                    delay,
                    lastPointCount: 2
                });
            }
        }
    });
}

function clearHoverArcs() {
    activeHoverArcs.forEach(a => { 
        hoverArcsGroup.remove(a.arc); 
        a.arc.geometry?.dispose(); 
    });
    activeHoverArcs = [];
}

function updateHoverArcs(dt) {
    activeHoverArcs.forEach(a => {
        if (a.progress < 1) {
            // Smooth easing for animation
            a.progress = Math.min(1, a.progress + dt * 1.0);
            const easedProgress = 1 - Math.pow(1 - a.progress, 2); // Ease out quad
            const cnt = Math.max(2, Math.floor(easedProgress * a.allPoints.length));
            
            // Only update geometry if point count changed
            if (cnt !== a.lastPointCount && cnt >= 2) {
                a.lastPointCount = cnt;
                const pts = a.allPoints.slice(0, cnt);
                const curve = new THREE.CatmullRomCurve3(pts);
                curve.tension = 0.5;
                a.arc.geometry?.dispose();
                a.arc.geometry = new THREE.TubeGeometry(curve, Math.max(4, Math.floor(cnt / 3)), CONFIG.arcThickness, 6, false);
            }
        }
    });
}

// ============ INTERACTION ============
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let isDragging = false, prevMouse = { x: 0, y: 0 };
let globeRotation = { x: 0, y: 0 };
const tooltip = document.getElementById('region-tooltip');

function showTooltip(region, x, y) {
    const delays = NETWORK_DELAYS[region.name];
    if (!delays) return;

    tooltip.querySelector('.region-name').innerHTML = `<span class="flag">${region.flag}</span> ${region.name}`;
    const sorted = Object.keys(delays).sort((a, b) => delays[a] - delays[b]);
    tooltip.querySelector('.delay-list').innerHTML = sorted.map(t => {
        const d = delays[t], cls = d < 80 ? 'low' : d < 150 ? 'medium' : 'high';
        const tr = REGIONS.find(rr => rr.name === t);
        return `<div class="delay-item"><span class="target-name"><span class="flag">${tr?.flag || ''}</span> ${t}</span><span class="delay-value ${cls}">${d} ms</span></div>`;
    }).join('');
    tooltip.style.display = 'block';
    tooltip.style.left = (x + 20) + 'px';
    tooltip.style.top = (y - 10) + 'px';
    const rect = tooltip.getBoundingClientRect();
    if (rect.right > window.innerWidth) tooltip.style.left = (x - rect.width - 20) + 'px';
    if (rect.bottom > window.innerHeight) tooltip.style.top = (y - rect.height - 10) + 'px';
}

function hideTooltip() { tooltip.style.display = 'none'; }

globeContainer.addEventListener('mousemove', e => {
    const rect = globeContainer.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

    if (isDragging) {
        globeRotation.y += (e.clientX - prevMouse.x) * 0.008;
        globeRotation.x += (e.clientY - prevMouse.y) * 0.008;
        globeRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, globeRotation.x));
        globeGroup.rotation.y = globeRotation.y;
        globeGroup.rotation.x = globeRotation.x;
    } else {
        raycaster.setFromCamera(mouse, camera);
        let closest = null, closestDist = Infinity;

        regionMarkers.forEach(r => {
            const wp = r.marker.getWorldPosition(new THREE.Vector3());
            const dist = raycaster.ray.distanceToPoint(wp);
            const camDist = camera.position.distanceTo(wp);
            if (dist < 2.2 && camDist < closestDist) {
                const hits = raycaster.intersectObject(globe);
                if (hits.length === 0 || hits[0].distance > camDist - 1) {
                    closest = r; closestDist = camDist;
                }
            }
        });

        if (closest && closest !== hoveredRegion) {
            hoveredRegion = closest;
            clearHoverArcs();
            activateHoverArcs(hoveredRegion);
            regionMarkers.forEach(r => {
                r.marker.scale.setScalar(r === hoveredRegion ? 2 : 1);
                r.ring.material.opacity = r === hoveredRegion ? 0.6 : 0.35;
            });
            showTooltip(hoveredRegion, e.clientX, e.clientY);
        } else if (closest === hoveredRegion && hoveredRegion) {
            showTooltip(hoveredRegion, e.clientX, e.clientY);
        } else if (!closest && hoveredRegion) {
            hoveredRegion = null;
            clearHoverArcs();
            regionMarkers.forEach(r => { r.marker.scale.setScalar(1); r.ring.material.opacity = 0.35; });
            hideTooltip();
        }
    }
    prevMouse = { x: e.clientX, y: e.clientY };
});

globeContainer.addEventListener('mousedown', e => {
    if (e.button === 0) { isDragging = true; prevMouse = { x: e.clientX, y: e.clientY }; globeContainer.style.cursor = 'grabbing'; hideTooltip(); }
});

globeContainer.addEventListener('mouseup', () => { isDragging = false; globeContainer.style.cursor = 'grab'; });
globeContainer.addEventListener('mouseleave', () => { 
    isDragging = false; 
    globeContainer.style.cursor = 'grab';
    if (hoveredRegion) {
        hoveredRegion = null;
        clearHoverArcs();
        regionMarkers.forEach(r => { r.marker.scale.setScalar(1); r.ring.material.opacity = 0.35; });
        hideTooltip();
    }
});

// No wheel zoom - scroll behavior only controlled by page scroll

window.addEventListener('resize', () => {
    camera.aspect = globeContainer.clientWidth / globeContainer.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(globeContainer.clientWidth, globeContainer.clientHeight);
});

// ============ UPDATE LABELS ============
function updateLabels() {
    const rect = globeContainer.getBoundingClientRect();
    const cameraPos = camera.position.clone();
    
    regionMarkers.forEach(r => {
        const wp = r.marker.getWorldPosition(new THREE.Vector3());
        const vec = wp.clone().project(camera);
        const x = rect.left + (vec.x * 0.5 + 0.5) * rect.width;
        const y = rect.top + (-vec.y * 0.5 + 0.5) * rect.height;

        // Get the globe center (accounting for rotation)
        const globeCenter = globeGroup.position.clone();
        
        // Vector from globe center to marker (this is the "outward normal" of the marker on the sphere)
        const markerNormal = wp.clone().sub(globeCenter).normalize();
        
        // Vector from globe center to camera
        const toCamera = cameraPos.clone().sub(globeCenter).normalize();
        
        // Dot product: positive means marker faces camera, negative means it's on the back
        const facingCamera = markerNormal.dot(toCamera);
        
        // Determine visibility
        const isFrontSide = facingCamera > 0.15; // Front-facing
        const isBackSide = facingCamera < -0.15; // Back-facing
        // else it's on the edge/silhouette

        // Set opacity: 100% for front, 33% for back, fade for edge
        if (isFrontSide) {
            r.label.style.opacity = '1';
            r.marker.material.opacity = 0.95;
            r.ring.material.opacity = 0.25;
            r.pulse.material.opacity = 0.12;
            r.baseDot.material.opacity = 0.9;
            r.pole.material.opacity = 0.4;
        } else if (isBackSide) {
            r.label.style.opacity = '0.33';
            r.marker.material.opacity = 0.33;
            r.ring.material.opacity = 0.08;
            r.pulse.material.opacity = 0.04;
            r.baseDot.material.opacity = 0.3;
            r.pole.material.opacity = 0.13;
        } else {
            // Edge - transitioning, make semi-transparent
            const edgeOpacity = (facingCamera + 0.15) / 0.3; // 0 to 1 as it transitions
            r.label.style.opacity = Math.max(0.1, edgeOpacity).toString();
            r.marker.material.opacity = 0.33 + edgeOpacity * 0.62;
            r.ring.material.opacity = 0.08 + edgeOpacity * 0.17;
            r.pulse.material.opacity = 0.04 + edgeOpacity * 0.08;
            r.baseDot.material.opacity = 0.3 + edgeOpacity * 0.6;
            r.pole.material.opacity = 0.13 + edgeOpacity * 0.27;
        }
        
        r.label.style.left = (x + 12) + 'px';
        r.label.style.top = (y - 6) + 'px';

        // Make rings face camera
        r.ring.lookAt(camera.position);
        r.pulse.lookAt(camera.position);
    });
}

// ============ ANIMATION ============
let lastTime = 0;
function animate(time) {
    requestAnimationFrame(animate);
    const dt = (time - lastTime) / 1000;
    lastTime = time;

    // Smooth zoom
    camera.position.z += (targetZoom - camera.position.z) * 0.08;

    if (!isDragging) {
        globeRotation.y += CONFIG.rotationSpeed;
        globeGroup.rotation.y = globeRotation.y;
    }

    atmosphereMaterial.uniforms.time.value = time / 1000;

    regionMarkers.forEach((r, i) => {
        const pulse = Math.sin(time / 1000 * 2 + i * 0.5) * 0.25 + 1;
        r.pulse.scale.setScalar(pulse);
        r.pulse.material.opacity = 0.12 * (2 - pulse);
    });

    if (activeHoverArcs.length > 0) updateHoverArcs(dt);
    updateDataPackets(dt);
    updateLabels();

    renderer.render(scene, camera);
}
animate(0);

// ============ GLOBE STATUS INDICATORS ============
function updateGlobeStatusIndicators() {
    const warningIcon = '<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>';
    const maintenanceIcon = '<svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>';
    
    regionMarkers.forEach(marker => {
        const regionData = REGION_STATUS_DATA.find(r => r.name === marker.name);
        if (regionData && marker.label) {
            let statusHtml = '';
            let statusColor = null;
            
            if (regionData.status === 'outage') {
                statusHtml = `<span class="status-indicator outage">${warningIcon}</span>`;
                statusColor = 0xFF5566; // Red
            } else if (regionData.status === 'degraded') {
                statusHtml = `<span class="status-indicator degraded">${warningIcon}</span>`;
                statusColor = 0xFFB432; // Yellow/Orange
            } else if (regionData.status === 'maintenance') {
                statusHtml = `<span class="status-indicator maintenance">${maintenanceIcon}</span>`;
                statusColor = 0x3B82F6; // Blue
            }
            
            marker.label.innerHTML = `<span class="flag">${marker.flag}</span> ${marker.name}${statusHtml}`;
            
            // Update marker color based on status
            if (statusColor && marker.markerMat) {
                marker.markerMat.color.setHex(statusColor);
                if (marker.ringMat) marker.ringMat.color.setHex(statusColor);
                if (marker.pulseMat) marker.pulseMat.color.setHex(statusColor);
            }
        }
    });
}

// ============ AUTO-INIT IF DATA ALREADY LOADED ============
if (typeof window._pendingGlobeInit === 'function') {
    window._pendingGlobeInit();
    delete window._pendingGlobeInit;
}
